<?xml version="1.0"?>
<launch>
    <!-- =============== local-cocobot =============== -->
    <!-- config file path  -->
    <arg name="rviz_settings" default="$(find target_path_planner)/config/rviz/debug_with_ccv.rviz"/>
    <arg name="straight_line_creator_settings" default="$(find straight_line_creator)/config/param/straight_line_creator_debug.yaml"/>
    <arg name="local_goal_maker_settings" default="$(find local_goal_maker)/config/param/local_goal_maker_debug.yaml"/>
    <arg name="pedestrian_state_predictor_settings" default="$(find pedestrian_state_predictor)/config/param/pedestrian_state_predictor_debug.yaml"/>
    <arg name="cost_map_creator_settings" default="$(find cost_map_creator)/config/param/cost_map_creator_debug.yaml"/>
    <arg name="target_path_planner_settings" default="$(find target_path_planner)/config/param/target_path_planner_debug.yaml"/>

    <!-- node launch -->
    <node pkg="straight_line_creator" type="straight_line_creator_node" name="straight_line_creator">
        <rosparam command="load" file="$(arg straight_line_creator_settings)"/>
    </node>
    <node pkg="local_goal_maker" type="local_goal_maker_node" name="local_goal_maker">
        <rosparam command="load" file="$(arg local_goal_maker_settings)"/>
        <remap from="/robot_odom" to="/sq2_ccv/diff_drive_steering_controller/odom"/>
    </node>
    <node pkg="pedestrian_state_predictor" type="pedestrian_state_predictor_node" name="pedestrian_state_predictor">
        <rosparam command="load" file="$(arg pedestrian_state_predictor_settings)"/>
        <remap from="/robot_odom" to="/sq2_ccv/diff_drive_steering_controller/odom"/>
    </node>
    <node pkg="cost_map_creator" type="cost_map_creator_node" name="cost_map_creator">
        <rosparam command="load" file="$(arg cost_map_creator_settings)"/>
    </node>
    <node pkg="target_path_planner" type="target_path_planner_node" name="target_path_planner" output="screen">
        <rosparam command="load" file="$(arg target_path_planner_settings)"/>
    </node>

    <!-- rviz -->
    <node pkg="rviz" type="rviz" name="planner_rviz" args="-d $(arg rviz_settings)"/>
    
    <!-- =============== Move ccv =============== -->
    <node name="pure_pursuit_steering" pkg="ccv_pure_pursuit_steering" type="ccv_pure_pursuit_steering">
        <param name="max_target_velocity" value="1.2"/>
        <param name="max_steering_angle" value="20.0"/>
        <param name="hz" value="30"/>
        <param name="L1" value="1.0"/>
        <param name="L2" value="0.5"/>
        <param name="goal_border" value="0.5"/>
        <param name="read_marker" value="false"/>
        <param name="world_frame_id" value="odom"/>
        <param name="robot_frame_id" value="base_footprint"/>
        <remap from="/predicted_path" to="/target_path"/>
        <remap from="/local/cmd_vel" to="/sq2_ccv/diff_drive_steering_controller/cmd_vel"/>
    </node>

    <node name="steering_angle_publisher" pkg="ccv_pure_pursuit_steering" type="steering_angle_publisher"/>

    <node pkg="rviz" type="rviz" name="ccv_rviz" args="-d $(find steering_path_planner)/config/debug_trj_test.rviz"/>
    
    <!-- =============== Simulator =============== -->
    <!-- 歩行者50人 -->

    <!-- bag play -->
    <param name="use_sim_time" value="true" type="bool"/>
    <node pkg="rosbag" type="play" name="play" args="$(env HOME)/bag/ped50/1.bag --clock"/>

    <!-- visualize ccv -->
    <param name="robot_description" command="$(find xacro)/xacro $(find sq2_ccv_description)/robot/sq2_ccv.urdf"/>
    <node name="joint_state_publisher" pkg="joint_state_publisher" type="joint_state_publisher"/>
    <node name="robot_state_publisher" pkg="robot_state_publisher" type="robot_state_publisher"/>

    <!-- rviz -->
    <node pkg="rviz" type="rviz" name="sim_rviz" args="-d $(find pedsim_simulator)/rviz/with_ccv.rviz"/>

    <!-- =============== bag record =============== -->
    <node name="bag_rec" pkg="rosbag" type="record" args="record -a -o $(env HOME)/bag/coco50/test.bag"/>
</launch>